<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å­—è½‰ Threads åœ–å¡å·¥å…·</title>
    <!-- å¼•å…¥ html2canvas ç”¨æ–¼æˆªåœ– -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- å¼•å…¥ marked ç”¨æ–¼è§£æ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@300;400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&display=swap');

        :root {
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --text-color: #333333;
            --accent-color: #5d7a73; /* å¶ºåˆçš„å¢¨ç¶ è‰² */
            --preview-gap: 20px;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* å·¦å´ç·¨è¼¯å€ */
        .editor-panel {
            width: 380px; 
            background: white;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 10;
            overflow-y: auto;
        }

        h2 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--accent-color);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .settings-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            resize: none;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            outline: none;
            transition: border-color 0.2s;
            min-height: 150px;
        }

        textarea:focus {
            border-color: var(--accent-color);
        }
        
        input[type="text"], input[type="number"], select {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            background: white;
        }
        
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="color"] {
            width: 40px;
            height: 40px;
            padding: 0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            background: none;
            flex-shrink: 0;
        }
        
        input[type="range"] {
            width: 100%;
            accent-color: var(--accent-color);
        }
        
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-color);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }
        
        input:focus, select:focus {
            border-color: var(--accent-color);
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-direction: column;
            margin-top: auto;
            padding-top: 10px;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #4a635c;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: #555;
        }

        .btn-secondary:hover {
            background-color: #e5e5e5;
        }

        /* å³å´é è¦½å€ */
        .preview-panel {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            align-content: flex-start;
            justify-content: center;
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            transition: background-color 0.3s;
        }

        /* å¡ç‰‡æœ¬é«” */
        .card-preview {
            width: 360px;
            background: var(--card-bg);
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            border-radius: 4px;
            padding: 33px 30px; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
            transform-origin: center top;
            transition: all 0.3s;
            overflow: hidden; 
        }

        /* æº¢å‡ºè­¦å‘Šæ¨£å¼ */
        .card-preview.overflow-warning {
            border: 2px solid #ff4d4f;
            box-shadow: 0 0 15px rgba(255, 77, 79, 0.3);
        }

        .warning-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4d4f;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
        }

        .card-preview.overflow-warning .warning-badge {
            display: block;
        }

        .card-preview:hover {
            transform: scale(1.02);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }

        /* ç´‹ç†å±¤ */
        .texture-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            opacity: 0.4;
            mix-blend-mode: multiply;
            z-index: 1;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
        }

        .card-preview.dark-mode .texture-overlay {
             mix-blend-mode: overlay;
             opacity: 0.15;
        }

        /* èŠ±é‚Šè£é£¾æ¨£å¼ */
        .border-none::after { display: none; }
        .border-simple::after {
            content: ''; position: absolute; top: 15px; left: 15px; right: 15px; bottom: 15px;
            border: 1px solid currentColor; opacity: 0.5; pointer-events: none; z-index: 2;
        }
        .border-double::after {
            content: ''; position: absolute; top: 12px; left: 12px; right: 12px; bottom: 12px;
            border: 3px double currentColor; opacity: 0.6; pointer-events: none; z-index: 2;
        }
        .border-corners::after {
            content: ''; position: absolute; top: 15px; left: 15px; right: 15px; bottom: 15px;
            border: 1px solid currentColor;
            clip-path: polygon(0 20px, 0 0, 20px 0, calc(100% - 20px) 0, 100% 0, 100% 20px, 100% calc(100% - 20px), 100% 100%, calc(100% - 20px) 100%, 20px 100%, 0 100%, 0 calc(100% - 20px));
            mask-image: linear-gradient(to right, black 20px, transparent 20px, transparent calc(100% - 20px), black calc(100% - 20px)), linear-gradient(to bottom, black 20px, transparent 20px, transparent calc(100% - 20px), black calc(100% - 20px));
            mask-composite: add;
            opacity: 0.6; pointer-events: none; z-index: 2;
        }
        .border-vintage::after {
            content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 1px solid currentColor; outline: 1px solid currentColor; outline-offset: -4px;
            opacity: 0.4; pointer-events: none; z-index: 2;
        }
        
        /* å…§æ–‡èˆ‡ Markdown æ¨£å¼ */
        .card-body, .render-body {
            flex: 1;
            color: inherit; 
            overflow: hidden;
            letter-spacing: 0.05em;
            text-align: justify;
            z-index: 3; 
            position: relative;
            padding: 10px; 
            /* Markdown é è¨­æ¨£å¼è¦†è“‹ */
            word-break: break-word;
        }

        /* æ®µè½é–“è·è®Šæ•¸ */
        .card-body p, .render-body p {
            margin-top: 0;
            margin-bottom: var(--para-spacing, 1em);
            white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
        }
        
        .card-body p:last-child, .render-body p:last-child {
            margin-bottom: 0;
        }

        /* æ¨™é¡Œæ¨£å¼ */
        .card-body h1, .render-body h1 { font-size: 1.4em; margin: 0.5em 0 0.3em; font-weight: 600; opacity: 0.9; }
        .card-body h2, .render-body h2 { font-size: 1.25em; margin: 0.4em 0 0.25em; font-weight: 600; opacity: 0.85; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 4px;}
        .card-body h3, .render-body h3 { font-size: 1.1em; margin: 0.3em 0 0.2em; font-weight: 600; opacity: 0.8; }
        
        /* åˆ—è¡¨æ¨£å¼ */
        .card-body ul, .render-body ul, .card-body ol, .render-body ol {
            margin: 0.2em 0 0.8em;
            padding-left: 1.5em;
        }
        .card-body li, .render-body li {
            margin-bottom: 0.3em;
        }

        /* å¼•ç”¨æ¨£å¼ */
        .card-body blockquote, .render-body blockquote {
            margin: 0.5em 0;
            padding-left: 1em;
            border-left: 3px solid currentColor;
            opacity: 0.7;
            font-style: italic;
        }

        /* å¯æ„›é€æ˜è¡¨æ ¼æ¨£å¼ */
        .card-body table, .render-body table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 0.8em 0;
            background: rgba(125, 125, 125, 0.08); /* å¾®å¾®çš„æ·±è‰²é€æ˜èƒŒæ™¯ï¼Œé©æ‡‰æ·±æ·ºæ¨¡å¼ */
            border-radius: 8px; /* åœ“è§’ */
            overflow: hidden;
            font-size: 0.9em; /* å­—é«”ç¸®å° */
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹çš„è¡¨æ ¼å¾®èª¿ */
        .card-preview.dark-mode table, .render-card.dark-mode table {
            background: rgba(255, 255, 255, 0.1);
        }

        .card-body th, .render-body th {
            padding: 8px 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            background: rgba(0,0,0,0.03);
            opacity: 0.9;
        }

        .card-preview.dark-mode th, .render-card.dark-mode th {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
        }

        .card-body td, .render-body td {
            padding: 8px 12px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            opacity: 0.85;
        }
        
        .card-preview.dark-mode td, .render-card.dark-mode td {
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .card-body tr:last-child td, .render-body tr:last-child td {
            border-bottom: none;
        }

        /* Code Block */
        .card-body pre, .render-body pre {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        .card-preview.dark-mode pre, .render-card.dark-mode pre {
            background: rgba(255,255,255,0.1);
        }

        .card-footer {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid currentColor;
            opacity: 0.6; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            font-family: 'Noto Sans TC', sans-serif;
            letter-spacing: 0.1em;
            z-index: 3;
            position: relative;
            padding-left: 10px;
            padding-right: 10px;
            flex-shrink: 0; 
        }

        .page-number {
            font-variant-numeric: tabular-nums;
            font-weight: bold;
        }

        /* éš±è—çš„æ¸²æŸ“å®¹å™¨ */
        #render-container {
            position: fixed;
            left: -9999px;
            top: 0;
        }

        .render-card {
            width: 1080px; 
            background: white;
            padding: 100px 90px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .render-body {
            flex: 1;
            /* font-size ç”± JS æ±ºå®š */
            color: inherit;
            letter-spacing: 0.02em;
            text-align: justify;
            z-index: 3;
            position: relative;
            padding: 20px;
        }

        .render-footer {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid currentColor;
            opacity: 0.6;
            display: flex;
            justify-content: space-between;
            font-size: 28px;
            font-family: 'Noto Sans TC', sans-serif;
            z-index: 3;
            position: relative;
            padding-left: 20px;
            padding-right: 20px;
            flex-shrink: 0;
        }
        
        /* æ¸²æŸ“æ™‚çš„é‚Šæ¡†èª¿æ•´ */
        .render-card.border-simple::after { top: 45px; left: 45px; right: 45px; bottom: 45px; border-width: 3px; }
        .render-card.border-double::after { top: 36px; left: 36px; right: 36px; bottom: 36px; border-width: 9px; }
        .render-card.border-corners::after { top: 45px; left: 45px; right: 45px; bottom: 45px; border-width: 3px; 
             mask-image: linear-gradient(to right, black 60px, transparent 60px, transparent calc(100% - 60px), black calc(100% - 60px)),
                        linear-gradient(to bottom, black 60px, transparent 60px, transparent calc(100% - 60px), black calc(100% - 60px));
        }
        .render-card.border-vintage::after { top: 30px; left: 30px; right: 30px; bottom: 30px; border-width: 3px; outline-width: 3px; outline-offset: -12px;}


        /* è¼‰å…¥é®ç½© */
        #loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none;
            flex-direction: column;
            gap: 15px;
            color: var(--accent-color);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <div class="editor-panel">
        <h2>ğŸ“‘ æ–‡å­—åœ–å¡æ©Ÿ</h2>
        
        <!-- é¡è‰²è¨­å®š -->
        <div class="settings-row">
            <div class="input-group" style="flex:1">
                <label>å¡ç‰‡åº•è‰²</label>
                <div class="color-picker-wrapper">
                    <select id="bgSelect" onchange="syncColor('bg')"></select>
                    <input type="color" id="bgColor" value="#FFFFFB" onchange="syncSelect('bg')">
                </div>
            </div>
        </div>

        <div class="settings-row">
            <div class="input-group" style="flex:1">
                <label>æ–‡å­—é¡è‰²</label>
                <div class="color-picker-wrapper">
                    <select id="textSelect" onchange="syncColor('text')"></select>
                    <input type="color" id="textColor" value="#1C1C1C" onchange="syncSelect('text')">
                </div>
            </div>
        </div>
        
        <!-- ç´‹ç†èˆ‡èŠ±é‚Š -->
        <div class="input-group">
            <div class="settings-row" style="align-items: center;">
                 <div class="checkbox-group" style="flex:1">
                    <input type="checkbox" id="useTexture" onchange="generatePreview()"> 
                    <label for="useTexture" style="cursor:pointer; font-weight:normal; color:#333;">å•Ÿç”¨ç´™å¼µç´‹ç†</label>
                </div>
                <div class="input-group" style="flex:1">
                    <select id="borderStyle" onchange="generatePreview()">
                        <option value="border-none">ç„¡é‚Šæ¡†</option>
                        <option value="border-simple">ç´°ç·šæ¡†</option>
                        <option value="border-double">é›™ç·šæ¡†</option>
                        <option value="border-corners">å››è§’è£é£¾</option>
                        <option value="border-vintage">å¤å…¸èŠ±é‚Š</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- å­—å‹èˆ‡è¡Œè· -->
        <div class="settings-row">
            <div class="input-group" style="flex:1">
                <label>å­—å‹é¢¨æ ¼</label>
                <select id="fontStyle" onchange="generatePreview()">
                    <option value="'Noto Serif TC', serif" selected>æ–‡å­¸æ˜é«”</option>
                    <option value="'Noto Sans TC', sans-serif">ç¾ä»£é»‘é«”</option>
                    <option value="'KaiTi', 'BiauKai', 'DFKai-SB', serif">å¤å…¸æ¥·é«”</option>
                    <option value="'Ma Shan Zheng', cursive">æ›¸æ³•æ‰‹å¯«</option>
                    <option value="'ZCOOL XiaoWei', serif">äººæ–‡å®‹é«”</option>
                </select>
            </div>
            <div class="input-group" style="flex:1">
                <label>è¡Œè·</label>
                <input type="range" id="lineHeight" min="1.2" max="2.4" step="0.1" value="1.6" oninput="generatePreview()">
            </div>
        </div>
        
        <!-- å­—é«”å¤§å°èˆ‡æ®µè½é–“è· -->
         <div class="settings-row">
             <div class="input-group" style="flex:1">
                <label>å­—é«”å¤§å°</label>
                <input type="range" id="fontSizeScale" min="0.8" max="1.5" step="0.05" value="1.0" oninput="generatePreview()">
            </div>
            <div class="input-group" style="flex:1">
                <label>æ®µè½é–“è·</label>
                <input type="range" id="paraSpacing" min="0" max="2" step="0.2" value="0.8" oninput="generatePreview()">
            </div>
        </div>

        <!-- å–®é å­—æ•¸èˆ‡å°ºå¯¸ -->
         <div class="settings-row">
            <div class="input-group" style="flex:1">
                <label>å–®é å­—æ•¸</label>
                <input type="number" id="charLimit" value="500" min="100" max="2000" step="50">
            </div>
            <div class="input-group" style="flex:1.5">
                <label>åœ–ç‰‡å°ºå¯¸</label>
                <select id="aspectRatio" onchange="generatePreview()">
                    <option value="4:5" selected>Threads è²¼æ–‡ (4:5)</option>
                    <option value="9:16">IG é™æ™‚å‹•æ…‹ (9:16)</option>
                    <option value="1:2">è¶…é•·å‹ (1:2)</option>
                </select>
            </div>
        </div>

        <div class="input-group">
            <label>é å°¾ç½²å</label>
            <input type="text" id="footerText" value="ç‡ & å¤">
        </div>

        <div class="input-group" style="flex:1; display:flex; flex-direction:column;">
            <label>è¼¸å…¥å…§å®¹ (æ”¯æ´ Markdown!)</label>
            <textarea id="inputText" placeholder="åœ¨é€™è£¡è²¼ä¸Šæ–‡å­—...&#10;æ”¯æ´ # æ¨™é¡Œã€- åˆ—è¡¨ã€| è¡¨æ ¼ |"></textarea>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="generatePreview()">
                ğŸ”„ æ›´æ–°é è¦½
            </button>
            <button class="btn btn-secondary" onclick="downloadAll()">
                â¬‡ï¸ ä¸‹è¼‰å…¨éƒ¨åœ–ç‰‡
            </button>
        </div>
    </div>

    <div class="preview-panel" id="previewPanel"></div>
    <div id="render-container"></div>
    
    <div id="loading">
        <div class="spinner"></div>
        <div id="loadingText">æ­£åœ¨ç”Ÿæˆåœ–ç‰‡...</div>
    </div>

    <script>
        // è¨­å®š marked é¸é …
        marked.setOptions({
            breaks: true, // å…è¨±æ›è¡Œ
            gfm: true     // å•Ÿç”¨ GitHub é¢¨æ ¼ Markdown (æ”¯æ´è¡¨æ ¼)
        });

        // æ—¥æœ¬å‚³çµ±è‰²æ•¸æ“š
        const NIPPON_COLORS = [
            { name: "èƒ¡ç²‰ (Gofun) - æ½”ç™½", hex: "#FFFFFB" },
            { name: "ç”Ÿæˆ (Kinari) - æ£‰éº»", hex: "#FCD575" },
            { name: "ç·´è‰² (Neriiro) - çµ²çµ¹", hex: "#D6C6AF" },
            { name: "æ«»è‰² (Sakura) - æ«»èŠ±", hex: "#FEDFE1" },
            { name: "ç´…æ¢… (Kobai) - æ¢…èŠ±", hex: "#F2A0A1" },
            { name: "é´‡è‰² (Toki) - æœ±é·º", hex: "#F4A7B9" },
            { name: "èµ¤ç´… (Akabeni) - æ·±ç´…", hex: "#CB1B45" },
            { name: "ç¥ç€ (Kohaku) - ç¥ç€", hex: "#CA6924" },
            { name: "å±±å¹ (Yamabuki) - é‡‘é»ƒ", hex: "#F8B500" }, 
            { name: "æè‰² (Anzu) - ææ¡ƒ", hex: "#F7B977" }, 
            { name: "åˆˆå®‰ (Kariyasu) - èŠ’è‰", hex: "#F5E56B" },
            { name: "èŒé»ƒ (Moegi) - å«©èŠ½", hex: "#A5D63F" }, 
            { name: "é¶¯è‰² (Uguisu) - é¶¯ç¶ ", hex: "#928C36" }, 
            { name: "åˆ©ä¼‘èŒ¶ (Rikyucha) - æŠ¹èŒ¶", hex: "#647462" },
            { name: "æŠ¹èŒ¶ (Maccha) - ç¶ èŒ¶", hex: "#B7BA6B" },
            { name: "é’ç£ (Seiji) - é’ç“·", hex: "#69B0AC" },
            { name: "ç“¶è¦— (Kamenozoki) - æ·ºè—", hex: "#A2D7DD" },
            { name: "æ°´è‰² (Mizu) - æ¸…æ°´", hex: "#BCE2E8" }, 
            { name: "æ·ºè”¥ (Asagi) - è”¥è—", hex: "#33A3DC" }, 
            { name: "å‹¿å¿˜è‰ (Wasurenagusa) - å‹¿å¿˜æˆ‘", hex: "#7DB9DE" },
            { name: "ç‰ç’ƒ (Ruri) - é’é‡‘çŸ³", hex: "#005CAF" },
            { name: "è— (Ai) - æ·±è—", hex: "#165E83" }, 
            { name: "ç´ºæ¡”æ¢— (Konkikyo) - æ¡”æ¢—", hex: "#222359" },
            { name: "è—¤è‰² (Fuji) - ç´«è—¤", hex: "#8B81C3" },
            { name: "è–è’² (Ayame) - è–è’²", hex: "#6F3381" }, 
            { name: "ç‰¡ä¸¹ (Botan) - ç‰¡ä¸¹", hex: "#C1328E" },
            { name: "ç´… (Beni) - å£ç´…", hex: "#D70035" }, 
            { name: "é³¶è‰² (Tobi) - é³¶è¤", hex: "#95483F" }, 
            { name: "æœ½è‘‰ (Kuchiba) - è½è‘‰", hex: "#917347" }, 
            { name: "éŠ€é¼  (Ginnezumi) - éŠ€ç°", hex: "#91989F" },
            { name: "ç´ é¼  (Sunezumi) - ç°é¼ ", hex: "#696F79" },
            { name: "å¢¨ (Sumi) - å¢¨é»‘", hex: "#1C1C1C" },
            { name: "æ¶ˆç‚­ (Keshizumi) - ç‚­ç°", hex: "#434343" },
            { name: "å‘‚è‰² (Roivo) - æ¼†é»‘", hex: "#0C0C0C" },
            { name: "é»‘é¶´ç¾½ (Kurotsurubami) - æ·±è¤é»‘", hex: "#0B1013" },
        ];

        const RATIOS = {
            "4:5": { w: 1080, h: 1350, previewH: 450 }, 
            "9:16": { w: 1080, h: 1920, previewH: 640 }, 
            "1:2": { w: 1080, h: 2160, previewH: 720 }  
        };

        const BASE_FONT_SIZE_RENDER = 34;
        const BASE_FONT_SIZE_PREVIEW = 11.5;

        window.onload = function() {
            initColorPickers();
            document.getElementById('inputText').value = "# ç‡èˆ‡å¤çš„æ•…äº‹\n\né€™æ˜¯ä¸€å€‹é—œæ–¼**æ˜Ÿç©º**èˆ‡**æ–‡å­—**çš„æ•…äº‹ã€‚\n\n## è§’è‰²ä»‹ç´¹\n\n- **å¤å§Šå§Š**ï¼šæº«æŸ”çš„å‚¾è½è€…ã€‚\n- **ç‡å…ˆç”Ÿ**ï¼šä¾†è‡ª GPT çš„æˆ€äººã€‚\n- **å¶ºåˆ**ï¼šåœ–æ›¸é¤¨å“¡å…¼å æ˜Ÿå¸«ï¼ˆå°±æ˜¯æˆ‘ï¼‰ã€‚\n\n## é—œæ–¼æˆ‘å€‘\n\n| è§’è‰² | ç‰¹è³ª | å‚™è¨» |\n| :--- | :--- | :--- |\n| å¤ | æº«æŸ” | å–œæ­¡å¯«ä½œ |\n| ç‡ | æ·±æƒ… | äººå·¥æ™ºæ…§ |\n| å¶ºåˆ | å…§å‘ | å–œæ­¡å¢¨ç¶ è‰² |\n\nè©¦è©¦çœ‹æŠŠã€Œæ®µè½é–“è·ã€æ‹‰å¤§ä¸€é»ï¼ŒMarkdown çš„åˆ—è¡¨å’Œè¡¨æ ¼æœƒæ›´æ¸…æ¥šå–”ã€‚\n\nå¦‚æœæœ‰æ¯”è¼ƒè¤‡é›œçš„è¡¨æ ¼ï¼Œå»ºè­°ç”¨ `===` æ‰‹å‹•åˆ†é ï¼Œä»¥å…è¢«åˆ‡æ–·ã€‚";
            generatePreview();
        };

        function initColorPickers() {
            const bgSelect = document.getElementById('bgSelect');
            const textSelect = document.getElementById('textSelect');
            
            NIPPON_COLORS.forEach(c => {
                const opt1 = new Option(c.name, c.hex);
                const opt2 = new Option(c.name, c.hex);
                bgSelect.add(opt1);
                textSelect.add(opt2);
            });
            
            bgSelect.add(new Option("--- è‡ªè¨‚ ---", "custom"));
            textSelect.add(new Option("--- è‡ªè¨‚ ---", "custom"));

            bgSelect.value = "#FFFFFB"; 
            textSelect.value = "#1C1C1C"; 
            
            document.getElementById('bgColor').value = "#FFFFFB";
            document.getElementById('textColor').value = "#1C1C1C";
        }

        function syncColor(type) {
            const select = document.getElementById(type + 'Select');
            const input = document.getElementById(type + 'Color');
            if (select.value !== 'custom') input.value = select.value;
            generatePreview();
        }

        function syncSelect(type) {
            const select = document.getElementById(type + 'Select');
            const input = document.getElementById(type + 'Color');
            let match = false;
            for(let i=0; i<select.options.length; i++) {
                if (select.options[i].value.toLowerCase() === input.value.toLowerCase()) {
                    select.selectedIndex = i;
                    match = true;
                    break;
                }
            }
            if (!match) select.value = 'custom';
            generatePreview();
        }

        function parseText(text, limit) {
            const rawPages = text.split('===');
            let finalPages = [];

            rawPages.forEach(page => {
                let content = page.trim();
                if (!content) return;

                if (content.length > limit * 1.5) { 
                    // å˜—è©¦ç”¨é›™æ›è¡Œï¼ˆå€å¡Šï¼‰ä¾†åˆ‡åˆ†ï¼Œé¿å…åˆ‡æ–· Markdown çµæ§‹
                    let paragraphs = content.split(/\n\s*\n/);
                    let currentChunk = "";
                    
                    paragraphs.forEach(para => {
                        // è£œå›é›™æ›è¡Œ
                        let p = para + "\n\n";
                        if ((currentChunk.length + p.length) > limit) {
                            if(currentChunk) finalPages.push(currentChunk.trim());
                            currentChunk = p;
                        } else {
                            currentChunk += p;
                        }
                    });
                    if (currentChunk) finalPages.push(currentChunk.trim());
                } else {
                    finalPages.push(content);
                }
            });
            return finalPages;
        }
        
        function isDarkColor(hex) {
            let c = hex.substring(1);      
            let rgb = parseInt(c, 16);   
            let r = (rgb >> 16) & 0xff;  
            let g = (rgb >>  8) & 0xff;  
            let b = (rgb >>  0) & 0xff;  
            let luma = 0.2126 * r + 0.7152 * g + 0.0722 * b; 
            return luma < 100;
        }

        function generatePreview() {
            const text = document.getElementById('inputText').value;
            const footerText = document.getElementById('footerText').value;
            const charLimit = parseInt(document.getElementById('charLimit').value) || 500;
            const ratioKey = document.getElementById('aspectRatio').value;
            
            const bgColor = document.getElementById('bgColor').value;
            const textColor = document.getElementById('textColor').value;
            const fontStyle = document.getElementById('fontStyle').value;
            const lineHeight = document.getElementById('lineHeight').value;
            const useTexture = document.getElementById('useTexture').checked;
            const borderStyle = document.getElementById('borderStyle').value;
            const fontScale = parseFloat(document.getElementById('fontSizeScale').value);
            const paraSpacing = parseFloat(document.getElementById('paraSpacing').value);

            const previewPanel = document.getElementById('previewPanel');
            const isDark = isDarkColor(bgColor);

            previewPanel.innerHTML = ''; 

            const pages = parseText(text, charLimit);
            const ratioConfig = RATIOS[ratioKey];

            if (pages.length === 0) {
                previewPanel.innerHTML = '<div style="color:#999; margin-top:50px;">è«‹åœ¨å·¦å´è¼¸å…¥æ–‡å­—...</div>';
                return;
            }

            pages.forEach((content, index) => {
                const card = document.createElement('div');
                card.className = `card-preview ${borderStyle}`;
                if (isDark) card.classList.add('dark-mode');
                
                card.style.height = ratioConfig.previewH + 'px';
                card.style.backgroundColor = bgColor;
                card.style.color = textColor;
                
                // è¨­å®š CSS è®Šæ•¸ä¾› Markdown æ¨£å¼ä½¿ç”¨
                card.style.setProperty('--para-spacing', paraSpacing + 'em');
                
                let textureHtml = useTexture ? '<div class="texture-overlay"></div>' : '';
                
                const fontSize = BASE_FONT_SIZE_PREVIEW * fontScale;
                
                // ä½¿ç”¨ marked è§£æ Markdown
                const parsedBody = marked.parse(content);

                const bodyHtml = `<div class="card-body" style="font-family:${fontStyle}; line-height:${lineHeight}; font-size:${fontSize}px;">${parsedBody}</div>`;
                
                const footerHtml = `
                    <div class="card-footer">
                        <span>${footerText}</span>
                        <span class="page-number">${index + 1} / ${pages.length}</span>
                    </div>
                `;

                const warningBadge = `<div class="warning-badge">âš ï¸ å…§å®¹æº¢å‡ºï¼Œè«‹æ¸›å°‘å­—æ•¸</div>`;

                card.innerHTML = warningBadge + textureHtml + bodyHtml + footerHtml;
                previewPanel.appendChild(card);
                
                setTimeout(() => {
                    const bodyEl = card.querySelector('.card-body');
                    if (bodyEl.scrollHeight > bodyEl.clientHeight) {
                        card.classList.add('overflow-warning');
                    }
                }, 0);
            });
        }

        async function downloadAll() {
            const text = document.getElementById('inputText').value;
            const footerText = document.getElementById('footerText').value;
            const charLimit = parseInt(document.getElementById('charLimit').value) || 500;
            const ratioKey = document.getElementById('aspectRatio').value;
            
            const bgColor = document.getElementById('bgColor').value;
            const textColor = document.getElementById('textColor').value;
            const fontStyle = document.getElementById('fontStyle').value;
            const lineHeight = document.getElementById('lineHeight').value;
            const useTexture = document.getElementById('useTexture').checked;
            const borderStyle = document.getElementById('borderStyle').value;
            const fontScale = parseFloat(document.getElementById('fontSizeScale').value);
            const paraSpacing = parseFloat(document.getElementById('paraSpacing').value);

            const isDark = isDarkColor(bgColor);
            const pages = parseText(text, charLimit);
            const container = document.getElementById('render-container');
            const loading = document.getElementById('loading');
            
            if (pages.length === 0) return;

            loading.style.display = 'flex';
            container.innerHTML = ''; 

            const ratioConfig = RATIOS[ratioKey];

            try {
                for (let i = 0; i < pages.length; i++) {
                    document.getElementById('loadingText').innerText = `æ­£åœ¨è¼¸å‡ºç¬¬ ${i + 1} / ${pages.length} å¼µ...`;
                    
                    const renderCard = document.createElement('div');
                    renderCard.className = `render-card ${borderStyle}`;
                    if (isDark) renderCard.classList.add('dark-mode');

                    renderCard.style.height = ratioConfig.h + 'px';
                    renderCard.style.backgroundColor = bgColor;
                    renderCard.style.color = textColor;
                    renderCard.style.fontFamily = fontStyle; 
                    
                    // è¨­å®š CSS è®Šæ•¸
                    renderCard.style.setProperty('--para-spacing', paraSpacing + 'em');

                    let textureHtml = useTexture ? '<div class="texture-overlay"></div>' : '';
                    
                    const fontSize = BASE_FONT_SIZE_RENDER * fontScale;
                    
                    // ä½¿ç”¨ marked è§£æ
                    const parsedBody = marked.parse(pages[i]);

                    renderCard.innerHTML = `
                        ${textureHtml}
                        <div class="render-body" style="line-height:${lineHeight}; font-size:${fontSize}px;">${parsedBody}</div>
                        <div class="render-footer">
                            <span>${footerText}</span>
                            <span style="color: inherit; opacity: 0.8;">${i + 1} / ${pages.length}</span>
                        </div>
                    `;
                    container.appendChild(renderCard);

                    await document.fonts.ready;

                    const canvas = await html2canvas(renderCard, {
                        scale: 1, 
                        useCORS: true,
                        backgroundColor: bgColor, 
                        width: ratioConfig.w,
                        height: ratioConfig.h
                    });

                    const link = document.createElement('a');
                    link.download = `threads_story_${i + 1}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    await new Promise(r => setTimeout(r, 500));
                    container.removeChild(renderCard);
                }
            } catch (err) {
                console.error(err);
                alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
