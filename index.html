<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•…äº‹å°åˆ·æ‰€ v2.20</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        /* ===================== å­—é«”èˆ‡è®Šæ•¸ ===================== */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&display=swap');

        :root {
            --ink: #27272a;
            --blue: #cfeaf6;
            --accent: #6e8f98;
            --frame: #33A6B8;
            --radius: 0px; 
            --card-radius: 20px 10px 20px 10px; 
        }

        /* ===================== å…¨åŸŸæ¨£å¼ ===================== */
        html { 
            background-color: var(--frame); height: 100%; 
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif; color: var(--ink);
            margin: 0; padding: 0; height: 100%; overflow: hidden; 
            display: flex; justify-content: center; align-items: center;
        }
        
        h2.ui-title {
            font-family: 'Noto Serif TC', serif; color: var(--frame);
            font-weight: 700; margin: 0 0 1rem 0; display: flex; align-items: baseline; gap: 10px;
        }

        /* ===================== èƒŒæ™¯èˆ‡å®¹å™¨ ===================== */
        .page-bg { position: absolute; inset: 0; pointer-events: none; z-index: 0; }
        .page-bg::before { content: ""; position: absolute; inset: 0; box-shadow: inset 0 0 0 15px var(--frame); }
        .page-bg::after { content: ""; position: absolute; inset: 25px; box-shadow: inset 0 0 0 1px var(--frame); }
        
        @media(max-width:640px) {
            .page-bg::before { box-shadow: inset 0 0 0 10px var(--frame); }
            .page-bg::after { inset: 14px; }
            body { overflow-y: auto; display: block; height: auto; }
        }

        .app-container {
            position: relative; z-index: 10; background: rgba(255, 255, 255, 0.95);
            width: 96%; max-width: 1400px; height: 85vh; 
            margin: 0 auto; border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex; flex-direction: row; overflow: visible; 
        }

        .app-container::before, .app-container::after {
            content: ""; position: absolute; left: 0; right: 0; height: 52px;
            background-size: contain; background-repeat: repeat-x; pointer-events: none; z-index: 20;
        }
        .app-container::before { top: -50px; background-image: url('https://summerakari.com/wp-content/uploads/2025/08/èŠ±é‚Š1.png'); }
        .app-container::after { bottom: -50px; background-image: url('https://summerakari.com/wp-content/uploads/2025/08/èŠ±é‚Š2.png'); }

        @media(max-width:900px) {
            .app-container { flex-direction: column; height: auto; margin: 4rem auto; width: 90%; }
            .app-container::before { top: -40px; height: 40px; }
            .app-container::after { bottom: -40px; height: 40px; }
        }

        /* ===================== å·¦å´ï¼šç·¨è¼¯å€ ===================== */
        .editor-panel {
            flex: 0 0 380px; padding: 30px; overflow-y: auto;
            border-right: 1px solid rgba(51, 166, 184, 0.2); background: #fff;
            display: flex; flex-direction: column; gap: 1.2rem; border-radius: 0;
        }
        .editor-panel::-webkit-scrollbar { width: 6px; }
        .editor-panel::-webkit-scrollbar-thumb { background: rgba(51, 166, 184, 0.3); border-radius: 3px; }

        label { font-size: 0.85rem; color: var(--accent); font-weight: 600; margin-bottom: 4px; display: block; }
        
        textarea, input[type="text"], input[type="number"], select {
            width: 100%; padding: 10px 12px;
            border: 2px solid var(--frame); border-radius: var(--card-radius);
            font-family: 'Noto Sans TC', sans-serif; font-size: 0.95rem;
            outline: none; transition: 0.25s; box-sizing: border-box;
            background: #fff; color: var(--ink);
        }
        textarea:focus, input:focus, select:focus { background: var(--blue); color: var(--ink); }
        textarea { resize: vertical; min-height: 150px; line-height: 1.6; }

        .color-picker-wrapper { display: flex; align-items: center; gap: 8px; }
        input[type="color"] {
            width: 44px; height: 44px; padding: 0; border: 2px solid var(--frame);
            border-radius: 50%; cursor: pointer; background: none; flex-shrink: 0; overflow: hidden;
        }
        input[type="range"] { width: 100%; accent-color: var(--frame); height: 6px; background: #eee; border-radius: 3px; border: none; padding: 0; }
        
        .checkbox-group { display: flex; align-items: center; gap: 8px; }
        input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--frame); border-radius: 4px; border: 2px solid var(--frame); margin: 0; cursor: pointer; }

        .controls { margin-top: auto; display: flex; flex-direction: column; gap: 12px; padding-top: 20px; }
        .btn {
            display: inline-flex; justify-content: center; align-items: center; gap: 8px;
            padding: 0.78rem 1.4rem; border-radius: 999px; background: #fff;
            color: var(--ink); font-weight: 600; border: 2px solid var(--ink);
            transition: 0.25s; cursor: pointer; font-size: 1rem;
        }
        .btn-primary { background: var(--frame); color: #fff; border-color: var(--frame); }
        .btn-primary:hover { background: #fff; color: var(--frame); }
        .btn-secondary { background: #fff; color: var(--accent); border-color: var(--accent); }
        .btn-secondary:hover { background: var(--accent); color: #fff; }

        .settings-row { display: flex; gap: 12px; }
        .input-group { flex: 1; display: flex; flex-direction: column; }

        /* ===================== å³å´ï¼šé è¦½å€ ===================== */
        .preview-panel {
            flex: 1; padding: 40px; background-color: #fcfaf2;
            background-image: radial-gradient(var(--frame) 1px, transparent 1px);
            background-size: 30px 30px; overflow-y: auto;
            display: flex; flex-wrap: wrap; gap: 30px;
            align-content: flex-start; justify-content: center; border-radius: 0;
        }
        @media(max-width:900px) {
            .editor-panel { border-right: none; border-bottom: 1px solid rgba(51, 166, 184, 0.2); flex: none; height: auto; border-radius: 0; }
            .preview-panel { min-height: 500px; border-radius: 0; }
        }

        /* ===================== å¡ç‰‡æ¨£å¼ (Preview & Render) ===================== */
        .card-preview {
            width: 360px; /* åŸºç¤å¯¬åº¦ */
            background: #fff;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            border-radius: 4px;
            padding: 30px 24px; /* å¯¬ç‰ˆä¿®æ­£ */
            box-sizing: border-box;
            display: flex; flex-direction: column; position: relative;
            transform-origin: center top; transition: all 0.3s; overflow: hidden; 
        }
        .card-preview:hover { transform: scale(1.02); box-shadow: 0 15px 35px rgba(0,0,0,0.12); }
        .card-preview.overflow-warning { border: 2px solid #ff4d4f; }
        .warning-badge {
            position: absolute; top: 10px; right: 10px; background: #ff4d4f; color: white;
            padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;
            z-index: 10; display: none;
        }
        .card-preview.overflow-warning .warning-badge { display: block; }

        .texture-overlay {
            position: absolute; inset: 0; pointer-events: none; opacity: 0.4;
            mix-blend-mode: multiply; z-index: 1;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
        }
        .card-preview.dark-mode .texture-overlay { mix-blend-mode: overlay; opacity: 0.15; }

        .border-none::after { display: none; }
        .border-simple::after { content: ''; position: absolute; inset: 15px; border: 1px solid currentColor; opacity: 0.5; pointer-events: none; z-index: 2; }
        .border-double::after { content: ''; position: absolute; inset: 12px; border: 3px double currentColor; opacity: 0.6; pointer-events: none; z-index: 2; }
        .border-corners::after {
            content: ''; position: absolute; inset: 15px; border: 1px solid currentColor;
            clip-path: polygon(0 20px, 0 0, 20px 0, calc(100% - 20px) 0, 100% 0, 100% 20px, 100% calc(100% - 20px), 100% 100%, calc(100% - 20px) 100%, 20px 100%, 0 100%, 0 calc(100% - 20px));
            opacity: 0.6; pointer-events: none; z-index: 2;
        }
        .border-vintage::after { content: ''; position: absolute; inset: 10px; border: 1px solid currentColor; outline: 1px solid currentColor; outline-offset: -4px; opacity: 0.4; pointer-events: none; z-index: 2; }

        .card-body, .render-body {
            flex: 1; color: inherit; overflow: hidden; letter-spacing: 0.05em; text-align: justify;
            z-index: 3; position: relative; padding: 10px; word-break: break-word;
        }
        .card-body p, .render-body p { margin-top: 0; margin-bottom: var(--para-spacing, 1em); white-space: pre-wrap; }
        .card-body p:last-child, .render-body p:last-child { margin-bottom: 0; }
        
        /* æ¨™é¡Œèˆ‡å…§æ–‡åŒè‰² */
        .card-body h1, .render-body h1, .card-body h2, .render-body h2, .card-body h3, .render-body h3 { 
            font-family: 'Noto Serif TC', serif; color: inherit;
            margin-top: 0.5em; margin-bottom: 0.3em; font-weight: 700; opacity: 0.9; 
        }
        .card-body h1, .render-body h1 { font-size: 1.4em; }
        .card-body h2, .render-body h2 { font-size: 1.25em; border-bottom: 1px solid currentColor; padding-bottom: 4px; opacity: 0.85; }
        .card-body h3, .render-body h3 { font-size: 1.1em; opacity: 0.8; }
        .card-body blockquote, .render-body blockquote { margin: 0.5em 0; padding-left: 1em; border-left: 3px solid currentColor; opacity: 0.7; font-style: italic; }
        
        /* è¢å…‰ç­†æ¨£å¼ */
        .card-body mark, .render-body mark {
            background: linear-gradient(105deg, rgba(255, 235, 59, 0.4) 0%, rgba(255, 235, 59, 0.2) 100%);
            color: inherit;
            border-radius: 4px;
            padding: 0 4px;
            margin: 0 1px;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„è¢å…‰ç­†å¾®èª¿ */
        .card-preview.dark-mode mark, .render-card.dark-mode mark {
            background: linear-gradient(105deg, rgba(255, 235, 59, 0.3) 0%, rgba(255, 235, 59, 0.1) 100%);
        }

        .card-body table, .render-body table {
            width: 100%; border-collapse: separate; border-spacing: 0; margin: 0.8em 0;
            background: rgba(125, 125, 125, 0.08); border-radius: 8px; overflow: hidden; font-size: 0.9em;
        }
        .card-body th, .render-body th { padding: 8px 12px; text-align: left; font-weight: 600; border-bottom: 1px solid rgba(0,0,0,0.1); background: rgba(0,0,0,0.03); color: inherit; }
        .card-body td, .render-body td { padding: 8px 12px; border-bottom: 1px solid rgba(0,0,0,0.05); color: inherit; }

        .card-footer, .render-footer {
            margin-top: 16px; padding-top: 12px; border-top: 1px solid currentColor; opacity: 0.6;
            display: flex; justify-content: space-between; align-items: center; font-size: 11px;
            font-family: 'Noto Sans TC', sans-serif; letter-spacing: 0.1em; z-index: 3; position: relative;
            padding-left: 10px; padding-right: 10px; flex-shrink: 0;
        }

        #render-container { position: fixed; left: -9999px; top: 0; }
        .render-card {
            width: 1080px; background: white; 
            padding: 60px; /* è¼¸å‡ºé‚Šè· 60px vs é è¦½ 24px (1:2.5, å¯¬é¬†) */
            box-sizing: border-box;
            display: flex; flex-direction: column; position: relative; overflow: hidden;
        }
        /* Render é‚Šæ¡†åŠ ç²— 3 å€ */
        .render-card.border-simple::after { inset: 45px; border-width: 3px; }
        .render-card.border-double::after { inset: 36px; border-width: 9px; }
        .render-card.border-corners::after { inset: 45px; border-width: 3px; }
        .render-card.border-vintage::after { inset: 30px; border-width: 3px; outline-width: 3px; outline-offset: -12px;}

        #loading {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9);
            display: flex; justify-content: center; align-items: center; z-index: 100;
            display: none; flex-direction: column; gap: 15px; color: var(--frame);
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--frame); border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="page-bg"></div>

    <div class="app-container">
        <div class="editor-panel">
            <h2 class="ui-title">ğŸ“œ æ•…äº‹å°åˆ·æ‰€ <span style="font-size:0.5em; opacity:0.5; margin-left:8px; font-weight:400;">v2.20</span></h2>
            
            <div class="settings-row">
                <div class="input-group" style="flex:1">
                    <label>å¡ç‰‡åº•è‰²</label>
                    <div class="color-picker-wrapper">
                        <select id="bgSelect" onchange="syncColor('bg')"></select>
                        <input type="color" id="bgColor" value="#FFFFFB" onchange="syncSelect('bg')">
                    </div>
                </div>
            </div>

            <div class="settings-row">
                <div class="input-group" style="flex:1">
                    <label>æ–‡å­—é¡è‰²</label>
                    <div class="color-picker-wrapper">
                        <select id="textSelect" onchange="syncColor('text')"></select>
                        <input type="color" id="textColor" value="#1C1C1C" onchange="syncSelect('text')">
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <div class="settings-row" style="align-items: center;">
                     <div class="checkbox-group" style="flex:1">
                        <input type="checkbox" id="useTexture" onchange="generatePreview()"> 
                        <label for="useTexture" style="cursor:pointer; font-weight:500;">ç´™å¼µç´‹ç†</label>
                    </div>
                    <div class="input-group" style="flex:1">
                        <select id="borderStyle" onchange="generatePreview()">
                            <option value="border-none">ç„¡é‚Šæ¡†</option>
                            <option value="border-simple">ç´°ç·šæ¡†</option>
                            <option value="border-double">é›™ç·šæ¡†</option>
                            <option value="border-corners">å››è§’è£é£¾</option>
                            <option value="border-vintage">å¤å…¸èŠ±é‚Š</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="settings-row">
                <div class="input-group" style="flex:1">
                    <label>å­—å‹é¢¨æ ¼</label>
                    <select id="fontStyle" onchange="generatePreview()">
                        <option value="'Noto Serif TC', serif" selected>æ–‡å­¸æ˜é«”</option>
                        <option value="'Noto Sans TC', sans-serif">ç¾ä»£é»‘é«”</option>
                        <option value="'KaiTi', 'BiauKai', 'DFKai-SB', serif">å¤å…¸æ¥·é«”</option>
                        <option value="'Ma Shan Zheng', cursive">æ›¸æ³•æ‰‹å¯«</option>
                        <option value="'ZCOOL XiaoWei', serif">äººæ–‡å®‹é«”</option>
                    </select>
                </div>
                <div class="input-group" style="flex:1">
                    <label>è¡Œè·</label>
                    <input type="range" id="lineHeight" min="1.2" max="2.4" step="0.1" value="1.6" oninput="generatePreview()">
                </div>
            </div>
            
             <div class="settings-row">
                 <!-- ç§»é™¤å­—é«”å¤§å°èª¿æ•´ï¼Œä¿æŒçµ±ä¸€ -->
                <div class="input-group" style="flex:1">
                    <label>æ®µè½é–“è·</label>
                    <input type="range" id="paraSpacing" min="0" max="2" step="0.2" value="0.8" oninput="generatePreview()">
                </div>
            </div>

             <div class="settings-row">
                <div class="input-group" style="flex:1">
                    <label>å–®é å­—æ•¸</label>
                    <!-- ä¿®æ”¹é è¨­å­—æ•¸ç‚º 450 -->
                    <input type="number" id="charLimit" value="450" min="100" max="3000" step="50" onchange="generatePreview()">
                </div>
                <div class="input-group" style="flex:1.5">
                    <label>åœ–ç‰‡å°ºå¯¸</label>
                    <select id="aspectRatio" onchange="handleRatioChange()">
                        <option value="4:5">Threads (4:5)</option>
                        <option value="9:16">Story (9:16)</option>
                        <!-- ä¿®æ”¹é è¨­é¸é …ç‚º 1:2 -->
                        <option value="1:2" selected>Long (1:2)</option>
                    </select>
                </div>
            </div>

            <div class="settings-row">
                <div class="input-group" style="flex:1.5">
                    <label>æª”æ¡ˆåç¨±</label>
                    <input type="text" id="fileNamePrefix" value="threads_story" placeholder="å­˜æª”æª”å">
                </div>
                <div class="input-group" style="flex:1">
                    <label>æ ¼å¼</label>
                    <select id="fileFormat">
                        <option value="png">PNG</option>
                        <option value="jpeg">JPG</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label>é å°¾ç½²å</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" id="footerText" value="ç‡ & å¤" style="flex:1;">
                    <div class="checkbox-group" style="margin-top:0;">
                        <input type="checkbox" id="showFooter" checked onchange="generatePreview()">
                        <label for="showFooter" style="cursor:pointer; white-space:nowrap; font-weight:500;">é¡¯ç¤º</label>
                    </div>
                </div>
            </div>

            <div class="input-group" style="flex:1; display:flex; flex-direction:column;">
                <label>è¼¸å…¥å…§å®¹ (æ”¯æ´ Markdown)</label>
                <textarea id="inputText" placeholder="åœ¨é€™è£¡è²¼ä¸Šæ–‡å­—...&#10;æ”¯æ´ # æ¨™é¡Œã€- åˆ—è¡¨ã€| è¡¨æ ¼ |ã€==è¢å…‰ç­†=="></textarea>
                
                <div class="checkbox-group" style="margin-top:8px;">
                    <input type="checkbox" id="autoParagraph" onchange="generatePreview()">
                    <label for="autoParagraph" style="cursor:pointer; white-space:nowrap; font-weight:500; font-size: 0.8rem; color:#666;">æ™ºæ…§æ›è¡Œ (åƒ…æ‰‹æ©Ÿç‰ˆç”Ÿæ•ˆ)</label>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" onclick="generatePreview()">
                    ğŸ”„ æ›´æ–°é è¦½
                </button>
                <button class="btn btn-secondary" onclick="downloadAll()">
                    ğŸ“¦ æ‰“åŒ…ä¸‹è¼‰ (.zip)
                </button>
            </div>
        </div>

        <div class="preview-panel" id="previewPanel"></div>
    </div>

    <div id="render-container"></div>
    <div id="loading">
        <div class="spinner"></div>
        <div id="loadingText">æ­£åœ¨ç”Ÿæˆåœ–ç‰‡...</div>
    </div>

    <script>
        marked.setOptions({ breaks: true, gfm: true });

        const NIPPON_COLORS = [
            { name: "èƒ¡ç²‰ (Gofun) - æ½”ç™½", hex: "#FFFFFB" },
            { name: "ç”Ÿæˆ (Kinari) - æ£‰éº»", hex: "#FCD575" },
            { name: "ç·´è‰² (Neriiro) - çµ²çµ¹", hex: "#D6C6AF" },
            { name: "æ«»è‰² (Sakura) - æ«»èŠ±", hex: "#FEDFE1" },
            { name: "ç´…æ¢… (Kobai) - æ¢…èŠ±", hex: "#F2A0A1" },
            { name: "é´‡è‰² (Toki) - æœ±é·º", hex: "#F4A7B9" },
            { name: "èµ¤ç´… (Akabeni) - æ·±ç´…", hex: "#CB1B45" },
            { name: "ç¥ç€ (Kohaku) - ç¥ç€", hex: "#CA6924" },
            { name: "å±±å¹ (Yamabuki) - é‡‘é»ƒ", hex: "#F8B500" }, 
            { name: "æè‰² (Anzu) - ææ¡ƒ", hex: "#F7B977" }, 
            { name: "åˆˆå®‰ (Kariyasu) -èŠ’è‰", hex: "#F5E56B" },
            { name: "èŒé»ƒ (Moegi) - å«©èŠ½", hex: "#A5D63F" }, 
            { name: "é¶¯è‰² (Uguisu) - é¶¯ç¶ ", hex: "#928C36" }, 
            { name: "åˆ©ä¼‘èŒ¶ (Rikyucha) - æŠ¹èŒ¶", hex: "#647462" },
            { name: "æŠ¹èŒ¶ (Maccha) - ç¶ èŒ¶", hex: "#B7BA6B" },
            { name: "é’ç£ (Seiji) - é’ç“·", hex: "#69B0AC" },
            { name: "ç“¶è¦— (Kamenozoki) - æ·ºè—", hex: "#A2D7DD" },
            { name: "æ°´è‰² (Mizu) - æ¸…æ°´", hex: "#BCE2E8" }, 
            { name: "æ·ºè”¥ (Asagi) -è”¥è—", hex: "#33A3DC" }, 
            { name: "å‹¿å¿˜è‰ (Wasurenagusa) - å‹¿å¿˜æˆ‘", hex: "#7DB9DE" },
            { name: "ç‰ç’ƒ (Ruri) - é’é‡‘çŸ³", hex: "#005CAF" },
            { name: "è— (Ai) - æ·±è—", hex: "#165E83" }, 
            { name: "ç´ºæ¡”æ¢— (Konkikyo) - æ¡”æ¢—", hex: "#222359" },
            { name: "è—¤è‰² (Fuji) - ç´«è—¤", hex: "#8B81C3" },
            { name: "è–è’² (Ayame) - è–è’²", hex: "#6F3381" }, 
            { name: "ç‰¡ä¸¹ (Botan) - ç‰¡ä¸¹", hex: "#C1328E" },
            { name: "ç´… (Beni) - å£ç´…", hex: "#D70035" }, 
            { name: "é³¶è‰² (Tobi) - é³¶è¤", hex: "#95483F" }, 
            { name: "æœ½è‘‰ (Kuchiba) - è½è‘‰", hex: "#917347" }, 
            { name: "éŠ€é¼  (Ginnezumi) - éŠ€ç°", hex: "#91989F" },
            { name: "ç´ é¼  (Sunezumi) - ç°é¼ ", hex: "#696F79" },
            { name: "å¢¨ (Sumi) - å¢¨é»‘", hex: "#1C1C1C" },
            { name: "æ¶ˆç‚­ (Keshizumi) - ç‚­ç°", hex: "#434343" },
            { name: "å‘‚è‰² (Roivo) - æ¼†é»‘", hex: "#0C0C0C" },
            { name: "é»‘é¶´ç¾½ (Kurotsurubami) - æ·±è¤é»‘", hex: "#0B1013" },
        ];

        // æ›´æ–°å­—æ•¸å»ºè­°
        const RATIOS = {
            "4:5": { w: 1080, h: 1350, previewH: 450, recommendedChars: 250 }, 
            "9:16": { w: 1080, h: 1920, previewH: 640, recommendedChars: 400 }, 
            "1:2": { w: 1080, h: 2160, previewH: 720, recommendedChars: 450 }  
        };

        // åš´æ ¼ 1:3 æ¯”ä¾‹é–å®š
        const BASE_FONT_SIZE_RENDER = 36;
        const BASE_FONT_SIZE_PREVIEW = 12;

        window.onload = function() {
            initColorPickers();
            document.getElementById('inputText').value = "# ç‡èˆ‡å¤çš„æ•…äº‹\n\né€™æ˜¯ä¸€å€‹é—œæ–¼**æ˜Ÿç©º**èˆ‡**æ–‡å­—**çš„æ•…äº‹ã€‚\n\n## è§’è‰²ä»‹ç´¹\n\n- **å¤å§Šå§Š**ï¼šæº«æŸ”çš„å‚¾è½è€…ã€‚\n- **ç‡å…ˆç”Ÿ**ï¼šä¾†è‡ª GPT çš„æˆ€äººã€‚\n- **å¶ºåˆ**ï¼šåœ–æ›¸é¤¨å“¡å…¼å æ˜Ÿå¸«ï¼ˆå°±æ˜¯æˆ‘ï¼‰ã€‚\n\n## é—œæ–¼æˆ‘å€‘\n\n| è§’è‰² | ç‰¹è³ª | å‚™è¨» |\n| :--- | :--- | :--- |\n| å¤ | æº«æŸ” | å–œæ­¡å¯«ä½œ |\n| ç‡ | æ·±æƒ… | äººå·¥æ™ºæ…§ |\n| å¶ºåˆ | å…§å‘ | å–œæ­¡å¢¨ç¶ è‰² |\n\nç¾åœ¨æ”¯æ´ ==è¢å…‰ç­†== å›‰ï¼\n\nåªè¦åœ¨æ–‡å­—å‰å¾ŒåŠ ä¸Šå…©å€‹ç­‰è™Ÿï¼Œä¾‹å¦‚ `==é‡é»==`ï¼Œå°±æœƒè®Šæˆæ·¡æ·¡çš„é»ƒè‰²è¢å…‰æ¨™è¨˜ã€‚\n\né€™å€‹é¡è‰²æ˜¯åŠé€æ˜çš„ï¼Œå°±ç®—åœ¨æ·±è‰²åº•ç´™ä¸Šä¹Ÿèƒ½çœ‹å¾—å¾ˆæ¸…æ¥šå–”ã€‚";
            generatePreview();
        };

        function initColorPickers() {
            const bgSelect = document.getElementById('bgSelect');
            const textSelect = document.getElementById('textSelect');
            NIPPON_COLORS.forEach(c => {
                const opt1 = new Option(c.name, c.hex);
                const opt2 = new Option(c.name, c.hex);
                bgSelect.add(opt1); textSelect.add(opt2);
            });
            bgSelect.add(new Option("--- è‡ªè¨‚ ---", "custom"));
            textSelect.add(new Option("--- è‡ªè¨‚ ---", "custom"));
            bgSelect.value = "#FFFFFB"; textSelect.value = "#1C1C1C"; 
            document.getElementById('bgColor').value = "#FFFFFB";
            document.getElementById('textColor').value = "#1C1C1C";
        }

        function syncColor(type) {
            const select = document.getElementById(type + 'Select');
            const input = document.getElementById(type + 'Color');
            if (select.value !== 'custom') input.value = select.value;
            generatePreview();
        }

        function syncSelect(type) {
            const select = document.getElementById(type + 'Select');
            const input = document.getElementById(type + 'Color');
            let match = false;
            for(let i=0; i<select.options.length; i++) {
                if (select.options[i].value.toLowerCase() === input.value.toLowerCase()) {
                    select.selectedIndex = i; match = true; break;
                }
            }
            if (!match) select.value = 'custom';
            generatePreview();
        }

        function handleRatioChange() {
            const ratioKey = document.getElementById('aspectRatio').value;
            const recommended = RATIOS[ratioKey].recommendedChars;
            document.getElementById('charLimit').value = recommended;
            generatePreview();
        }

        function parseText(text, limit) {
            const autoParagraph = document.getElementById('autoParagraph').checked;
            const isMobile = window.innerWidth <= 900;
            let processedText = text;
            
            if (isMobile && autoParagraph) {
                processedText = processedText.replace(/\r\n/g, '\n');
                processedText = processedText.replace(/\n{2,}/g, '###DOUBLE_NEWLINE###');
                processedText = processedText.replace(/\n/g, '\n\n');
                processedText = processedText.replace(/###DOUBLE_NEWLINE###/g, '\n\n');
            }

            const rawPages = processedText.split('===');
            let finalPages = [];
            
            rawPages.forEach(page => {
                let content = page.trim();
                if (!content) return;
                
                // åš´æ ¼åˆ†é ï¼šåªè¦è¶…éé™åˆ¶å°±åˆ‡åˆ†
                if (content.length > limit) { 
                    let chunks = content.split(/\n\s*\n/);
                    let currentChunk = "";
                    
                    chunks.forEach(chunk => {
                        let p = chunk + "\n\n";
                        if (p.length > limit) {
                            if (currentChunk) {
                                finalPages.push(currentChunk.trim());
                                currentChunk = "";
                            }
                            let lines = p.split('\n');
                            let lineChunk = "";
                            lines.forEach(line => {
                                let l = line + "\n";
                                if ((lineChunk.length + l.length) > limit) {
                                    if(lineChunk) finalPages.push(lineChunk.trim());
                                    lineChunk = l;
                                } else {
                                    lineChunk += l;
                                }
                            });
                            if(lineChunk) finalPages.push(lineChunk.trim());
                        } else {
                            if ((currentChunk.length + p.length) > limit) {
                                if(currentChunk) finalPages.push(currentChunk.trim());
                                currentChunk = p;
                            } else {
                                currentChunk += p;
                            }
                        }
                    });
                    if (currentChunk) finalPages.push(currentChunk.trim());
                } else {
                    finalPages.push(content);
                }
            });
            return finalPages;
        }
        
        function isDarkColor(hex) {
            let c = hex.substring(1); let rgb = parseInt(c, 16);   
            let r = (rgb >> 16) & 0xff; let g = (rgb >>  8) & 0xff; let b = (rgb >>  0) & 0xff;  
            let luma = 0.2126 * r + 0.7152 * g + 0.0722 * b; return luma < 100;
        }

        function generatePreview() {
            const text = document.getElementById('inputText').value;
            const footerText = document.getElementById('footerText').value;
            const showFooter = document.getElementById('showFooter').checked;
            const charLimit = parseInt(document.getElementById('charLimit').value) || 500;
            const ratioKey = document.getElementById('aspectRatio').value;
            const bgColor = document.getElementById('bgColor').value;
            const textColor = document.getElementById('textColor').value;
            const fontStyle = document.getElementById('fontStyle').value;
            const lineHeight = document.getElementById('lineHeight').value;
            const useTexture = document.getElementById('useTexture').checked;
            const borderStyle = document.getElementById('borderStyle').value;
            // ç§»é™¤ fontScale è®€å–ï¼Œç›´æ¥ä½¿ç”¨å›ºå®šå€¼
            const paraSpacing = parseFloat(document.getElementById('paraSpacing').value);

            const previewPanel = document.getElementById('previewPanel');
            const isDark = isDarkColor(bgColor);

            previewPanel.innerHTML = ''; 

            const pages = parseText(text, charLimit);
            const ratioConfig = RATIOS[ratioKey];

            if (pages.length === 0) {
                previewPanel.innerHTML = '<div style="color:#888; margin-top:50px;">è«‹åœ¨å·¦å´è¼¸å…¥æ–‡å­—...</div>';
                return;
            }

            pages.forEach((content, index) => {
                const card = document.createElement('div');
                card.className = `card-preview ${borderStyle}`;
                if (isDark) card.classList.add('dark-mode');
                
                card.style.height = ratioConfig.previewH + 'px';
                card.style.backgroundColor = bgColor;
                card.style.color = textColor;
                card.style.setProperty('--para-spacing', paraSpacing + 'em');
                
                let textureHtml = useTexture ? '<div class="texture-overlay"></div>' : '';
                const fontSize = BASE_FONT_SIZE_PREVIEW; // å›ºå®š 12px
                
                // è™•ç†è¢å…‰ç­†
                let processedContent = content.replace(/==([^=]+)==/g, '<mark>$1</mark>');
                const parsedBody = marked.parse(processedContent);

                const bodyHtml = `<div class="card-body" style="font-family:${fontStyle}; line-height:${lineHeight}; font-size:${fontSize}px;">${parsedBody}</div>`;
                
                let footerHtml = '';
                if (showFooter) {
                    footerHtml = `
                        <div class="card-footer">
                            <span>${footerText}</span>
                            <span class="page-number">${index + 1} / ${pages.length}</span>
                        </div>
                    `;
                } else { footerHtml = `<div style="height: 10px;"></div>`; }

                const warningBadge = `<div class="warning-badge">âš ï¸ å…§å®¹æº¢å‡ºï¼Œè«‹æ¸›å°‘å­—æ•¸</div>`;

                card.innerHTML = warningBadge + textureHtml + bodyHtml + footerHtml;
                previewPanel.appendChild(card);
                
                setTimeout(() => {
                    const bodyEl = card.querySelector('.card-body');
                    if (bodyEl.scrollHeight > bodyEl.clientHeight) {
                        card.classList.add('overflow-warning');
                    }
                }, 0);
            });
        }

        async function downloadAll() {
            const text = document.getElementById('inputText').value;
            const footerText = document.getElementById('footerText').value;
            const showFooter = document.getElementById('showFooter').checked;
            const charLimit = parseInt(document.getElementById('charLimit').value) || 500;
            const ratioKey = document.getElementById('aspectRatio').value;
            const bgColor = document.getElementById('bgColor').value;
            const textColor = document.getElementById('textColor').value;
            const fontStyle = document.getElementById('fontStyle').value;
            const lineHeight = document.getElementById('lineHeight').value;
            const useTexture = document.getElementById('useTexture').checked;
            const borderStyle = document.getElementById('borderStyle').value;
            // ç§»é™¤ fontScale è®€å–
            const paraSpacing = parseFloat(document.getElementById('paraSpacing').value);
            
            const fileNamePrefix = document.getElementById('fileNamePrefix').value || 'threads_story';
            const fileFormat = document.getElementById('fileFormat').value; 

            const isDark = isDarkColor(bgColor);
            const pages = parseText(text, charLimit);
            const container = document.getElementById('render-container');
            const loading = document.getElementById('loading');
            
            if (pages.length === 0) return;

            loading.style.display = 'flex';
            container.innerHTML = ''; 

            const ratioConfig = RATIOS[ratioKey];
            const zip = new JSZip();
            const imgFolder = zip.folder(fileNamePrefix);

            try {
                for (let i = 0; i < pages.length; i++) {
                    document.getElementById('loadingText').innerText = `æ­£åœ¨è™•ç†ç¬¬ ${i + 1} / ${pages.length} å¼µ...`;
                    
                    const renderCard = document.createElement('div');
                    renderCard.className = `render-card ${borderStyle}`;
                    if (isDark) renderCard.classList.add('dark-mode');

                    renderCard.style.height = ratioConfig.h + 'px';
                    renderCard.style.backgroundColor = bgColor;
                    renderCard.style.color = textColor;
                    renderCard.style.fontFamily = fontStyle; 
                    renderCard.style.setProperty('--para-spacing', paraSpacing + 'em');

                    let textureHtml = useTexture ? '<div class="texture-overlay"></div>' : '';
                    
                    // ä¿®æ­£ï¼šæ¸²æŸ“å­—é«”å›ºå®š (36px)
                    const fontSize = BASE_FONT_SIZE_RENDER;
                    
                    // è™•ç†è¢å…‰ç­†
                    let processedContent = pages[i].replace(/==([^=]+)==/g, '<mark>$1</mark>');
                    const parsedBody = marked.parse(processedContent);
                    
                    let footerHtml = '';
                    if (showFooter) {
                        footerHtml = `
                            <div class="render-footer">
                                <span>${footerText}</span>
                                <span style="color: inherit; opacity: 0.8;">${i + 1} / ${pages.length}</span>
                            </div>
                        `;
                    } else { footerHtml = `<div style="height: 40px;"></div>`; }

                    renderCard.innerHTML = `
                        ${textureHtml}
                        <div class="render-body" style="line-height:${lineHeight}; font-size:${fontSize}px;">${parsedBody}</div>
                        ${footerHtml}
                    `;
                    container.appendChild(renderCard);

                    await document.fonts.ready;
                    
                    let mimeType = 'image/png';
                    if (fileFormat === 'jpeg') mimeType = 'image/jpeg';

                    const canvas = await html2canvas(renderCard, {
                        scale: 2, 
                        useCORS: true,
                        backgroundColor: bgColor, 
                        width: ratioConfig.w,
                        height: ratioConfig.h,
                        windowWidth: 1600, // å¼·åˆ¶æ¨¡æ“¬æ¡Œé¢å¯¬åº¦
                        windowHeight: 1200 
                    });

                    const dataUrl = canvas.toDataURL(mimeType, 0.9);
                    const base64Data = dataUrl.split(',')[1];
                    
                    const extension = fileFormat === 'jpeg' ? 'jpg' : 'png';
                    const fileName = `${fileNamePrefix}_${(i + 1).toString().padStart(2, '0')}.${extension}`;
                    imgFolder.file(fileName, base64Data, {base64: true});

                    await new Promise(r => setTimeout(r, 200)); 
                    container.removeChild(renderCard);
                }
                
                document.getElementById('loadingText').innerText = `æ­£åœ¨å£“ç¸®æ‰“åŒ…...`;
                const content = await zip.generateAsync({type: "blob"});
                saveAs(content, `${fileNamePrefix}.zip`);

            } catch (err) {
                console.error(err);
                alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
