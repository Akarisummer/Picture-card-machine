<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å­—è½‰ Threads åœ–å¡å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@300;400;600&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&display=swap');

        :root {
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --text-color: #333333;
            --accent-color: #5d7a73; /* å¶ºåˆçš„å¢¨ç¶ è‰² */
            --preview-gap: 20px;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* å·¦å´ç·¨è¼¯å€ */
        .editor-panel {
            width: 380px; 
            background: white;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            z-index: 10;
            overflow-y: auto;
        }

        h2 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--accent-color);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .settings-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            resize: none;
            font-family: 'Noto Sans TC', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            outline: none;
            transition: border-color 0.2s;
            min-height: 150px;
        }

        textarea:focus {
            border-color: var(--accent-color);
        }
        
        input[type="text"], input[type="number"], select {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            background: white;
        }
        
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="color"] {
            width: 40px;
            height: 40px;
            padding: 0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            background: none;
            flex-shrink: 0;
        }
        
        input[type="range"] {
            width: 100%;
            accent-color: var(--accent-color);
        }
        
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-color);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }
        
        input:focus, select:focus {
            border-color: var(--accent-color);
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-direction: column;
            margin-top: auto;
            padding-top: 10px;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #4a635c;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: #555;
        }

        .btn-secondary:hover {
            background-color: #e5e5e5;
        }

        /* å³å´é è¦½å€ */
        .preview-panel {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            align-content: flex-start;
            justify-content: center;
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            transition: background-color 0.3s;
        }

        /* å¡ç‰‡æœ¬é«” */
        .card-preview {
            width: 360px;
            background: var(--card-bg);
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            border-radius: 4px;
            padding: 33px 30px; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
            transform-origin: center top;
            transition: all 0.3s;
            overflow: hidden; 
        }

        .card-preview:hover {
            transform: scale(1.02);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }

        /* ç´‹ç†å±¤ */
        .texture-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            opacity: 0.4;
            mix-blend-mode: multiply;
            z-index: 1;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
        }

        .card-preview.dark-mode .texture-overlay {
             mix-blend-mode: overlay;
             opacity: 0.15;
        }

        /* èŠ±é‚Šè£é£¾æ¨£å¼ (ä½¿ç”¨å½å…ƒç´ å¯¦ç¾ï¼Œé¡è‰²ç¹¼æ‰¿æ–‡å­—è‰²) */
        .border-none::after { display: none; }

        /* 1. ç´°ç·šæ¡† */
        .border-simple::after {
            content: '';
            position: absolute;
            top: 15px; left: 15px; right: 15px; bottom: 15px;
            border: 1px solid currentColor;
            opacity: 0.5;
            pointer-events: none;
            z-index: 2;
        }

        /* 2. é›™ç·šæ¡† */
        .border-double::after {
            content: '';
            position: absolute;
            top: 12px; left: 12px; right: 12px; bottom: 12px;
            border: 3px double currentColor;
            opacity: 0.6;
            pointer-events: none;
            z-index: 2;
        }

        /* 3. å››è§’è£é£¾ */
        .border-corners::after {
            content: '';
            position: absolute;
            top: 15px; left: 15px; right: 15px; bottom: 15px;
            border: 1px solid currentColor;
            /* åˆ©ç”¨ clip-path åˆ‡å‡ºå››å€‹è§’ */
            clip-path: polygon(
                0 20px, 0 0, 20px 0, 
                calc(100% - 20px) 0, 100% 0, 100% 20px,
                100% calc(100% - 20px), 100% 100%, calc(100% - 20px) 100%,
                20px 100%, 0 100%, 0 calc(100% - 20px)
            );
            /* ä¸­é–“æŒ–ç©ºï¼Œåªç•™è§’ */
            -webkit-mask: 
                linear-gradient(#fff, #fff),
                linear-gradient(#fff, #fff);
            -webkit-mask-size: 100% 100%;
            -webkit-mask-composite: destination-out;
            mask-composite: exclude;
            
            /* ä¸Šé¢maskå¤ªè¤‡é›œï¼Œç”¨ç°¡å–®çš„æ¼¸å±¤é®ç½©æ¨¡æ“¬å››è§’ */
            mask-image: linear-gradient(to right, black 20px, transparent 20px, transparent calc(100% - 20px), black calc(100% - 20px)),
                        linear-gradient(to bottom, black 20px, transparent 20px, transparent calc(100% - 20px), black calc(100% - 20px));
            mask-composite: add;
            
            opacity: 0.6;
            pointer-events: none;
            z-index: 2;
        }

        /* 4. å¤å…¸èŠ±é‚Š (CSS æ¨¡æ“¬) */
        .border-vintage::after {
            content: '';
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 1px solid currentColor;
            outline: 1px solid currentColor;
            outline-offset: -4px;
            opacity: 0.4;
            pointer-events: none;
            z-index: 2;
        }
        
        /* å…§æ–‡ */
        .card-body {
            flex: 1;
            /* font-size ç”± JS å‹•æ…‹æ±ºå®š */
            color: inherit; 
            white-space: pre-wrap;
            overflow: hidden;
            letter-spacing: 0.05em;
            text-align: justify;
            z-index: 3; 
            position: relative;
            /* è®“èŠ±é‚Šä¸å£“ä½æ–‡å­— */
            padding: 10px; 
        }

        .card-footer {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid currentColor;
            opacity: 0.6; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            font-family: 'Noto Sans TC', sans-serif;
            letter-spacing: 0.1em;
            z-index: 3;
            position: relative;
            padding-left: 10px;
            padding-right: 10px;
        }

        .page-number {
            font-variant-numeric: tabular-nums;
            font-weight: bold;
        }

        /* éš±è—çš„æ¸²æŸ“å®¹å™¨ */
        #render-container {
            position: fixed;
            left: -9999px;
            top: 0;
        }

        .render-card {
            width: 1080px; 
            background: white;
            padding: 100px 90px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .render-body {
            flex: 1;
            /* font-size ç”± JS æ±ºå®š */
            color: inherit;
            white-space: pre-wrap;
            letter-spacing: 0.02em;
            text-align: justify;
            z-index: 3;
            position: relative;
            padding: 20px;
        }

        .render-footer {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid currentColor;
            opacity: 0.6;
            display: flex;
            justify-content: space-between;
            font-size: 28px;
            font-family: 'Noto Sans TC', sans-serif;
            z-index: 3;
            position: relative;
            padding-left: 20px;
            padding-right: 20px;
        }
        
        /* æ¸²æŸ“æ™‚çš„é‚Šæ¡†èª¿æ•´ */
        .render-card.border-simple::after { top: 45px; left: 45px; right: 45px; bottom: 45px; border-width: 3px; }
        .render-card.border-double::after { top: 36px; left: 36px; right: 36px; bottom: 36px; border-width: 9px; }
        .render-card.border-corners::after { top: 45px; left: 45px; right: 45px; bottom: 45px; border-width: 3px; 
             mask-image: linear-gradient(to right, black 60px, transparent 60px, transparent calc(100% - 60px), black calc(100% - 60px)),
                        linear-gradient(to bottom, black 60px, transparent 60px, transparent calc(100% - 60px), black calc(100% - 60px));
        }
        .render-card.border-vintage::after { top: 30px; left: 30px; right: 30px; bottom: 30px; border-width: 3px; outline-width: 3px; outline-offset: -12px;}


        /* è¼‰å…¥é®ç½© */
        #loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none;
            flex-direction: column;
            gap: 15px;
            color: var(--accent-color);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <div class="editor-panel">
        <h2>ğŸ“‘ æ–‡å­—åœ–å¡æ©Ÿ</h2>
        
        <!-- é¡è‰²è¨­å®š -->
        <div class="settings-row">
            <div class="input-group" style="flex:1">
                <label>å¡ç‰‡åº•è‰²</label>
                <div class="color-picker-wrapper">
                    <select id="bgSelect" onchange="syncColor('bg')"></select>
                    <input type="color" id="bgColor" value="#FFFFFB" onchange="syncSelect('bg')">
                </div>
            </div>
        </div>

        <div class="settings-row">
            <div class="input-group" style="flex:1">
                <label>æ–‡å­—é¡è‰²</label>
                <div class="color-picker-wrapper">
                    <select id="textSelect" onchange="syncColor('text')"></select>
                    <input type="color" id="textColor" value="#1C1C1C" onchange="syncSelect('text')">
                </div>
            </div>
        </div>
        
        <!-- ç´‹ç†èˆ‡èŠ±é‚Š -->
        <div class="input-group">
            <div class="settings-row" style="align-items: center;">
                 <div class="checkbox-group" style="flex:1">
                    <input type="checkbox" id="useTexture" onchange="generatePreview()"> 
                    <label for="useTexture" style="cursor:pointer; font-weight:normal; color:#333;">å•Ÿç”¨ç´™å¼µç´‹ç†</label>
                </div>
                <div class="input-group" style="flex:1">
                    <select id="borderStyle" onchange="generatePreview()">
                        <option value="border-none">ç„¡é‚Šæ¡†</option>
                        <option value="border-simple">ç´°ç·šæ¡†</option>
                        <option value="border-double">é›™ç·šæ¡†</option>
                        <option value="border-corners">å››è§’è£é£¾</option>
                        <option value="border-vintage">å¤å…¸èŠ±é‚Š</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- å­—å‹èˆ‡è¡Œè· -->
        <div class="settings-row">
            <div class="input-group" style="flex:1">
                <label>å­—å‹é¢¨æ ¼</label>
                <select id="fontStyle" onchange="generatePreview()">
                    <option value="'Noto Serif TC', serif" selected>æ–‡å­¸æ˜é«”</option>
                    <option value="'Noto Sans TC', sans-serif">ç¾ä»£é»‘é«”</option>
                    <option value="'KaiTi', 'BiauKai', 'DFKai-SB', serif">å¤å…¸æ¥·é«”</option>
                    <option value="'Ma Shan Zheng', cursive">æ›¸æ³•æ‰‹å¯«</option>
                    <option value="'ZCOOL XiaoWei', serif">äººæ–‡å®‹é«”</option>
                </select>
            </div>
            <div class="input-group" style="flex:1">
                <label>è¡Œè·</label>
                <input type="range" id="lineHeight" min="1.2" max="2.4" step="0.1" value="1.6" oninput="generatePreview()">
            </div>
        </div>
        
        <!-- æ–°å¢å­—é«”å¤§å° -->
         <div class="settings-row">
             <div class="input-group" style="flex:1">
                <label>å­—é«”å¤§å° (ç¸®æ”¾)</label>
                <input type="range" id="fontSizeScale" min="0.8" max="1.5" step="0.05" value="1.0" oninput="generatePreview()">
            </div>
            <div class="input-group" style="flex:1">
                <label>å–®é å­—æ•¸</label>
                <input type="number" id="charLimit" value="500" min="100" max="2000" step="50">
            </div>
        </div>

        <div class="input-group">
            <label>åœ–ç‰‡å°ºå¯¸</label>
            <select id="aspectRatio" onchange="generatePreview()">
                <option value="4:5" selected>Threads è²¼æ–‡ (4:5)</option>
                <option value="9:16">IG é™æ™‚å‹•æ…‹ (9:16)</option>
                <option value="1:2">è¶…é•·å‹ (1:2)</option>
            </select>
        </div>

        <div class="input-group">
            <label>é å°¾ç½²å</label>
            <input type="text" id="footerText" value="ç‡ & å¤">
        </div>

        <div class="input-group" style="flex:1; display:flex; flex-direction:column;">
            <label>è¼¸å…¥å…§å®¹</label>
            <textarea id="inputText" placeholder="åœ¨é€™è£¡è²¼ä¸Šæ–‡å­—..."></textarea>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="generatePreview()">
                ğŸ”„ æ›´æ–°é è¦½
            </button>
            <button class="btn btn-secondary" onclick="downloadAll()">
                â¬‡ï¸ ä¸‹è¼‰å…¨éƒ¨åœ–ç‰‡
            </button>
        </div>
    </div>

    <div class="preview-panel" id="previewPanel"></div>
    <div id="render-container"></div>
    
    <div id="loading">
        <div class="spinner"></div>
        <div id="loadingText">æ­£åœ¨ç”Ÿæˆåœ–ç‰‡...</div>
    </div>

    <script>
        // æ—¥æœ¬å‚³çµ±è‰²æ•¸æ“š (è£œé½Šè‡³ 35 è‰²)
        const NIPPON_COLORS = [
            { name: "èƒ¡ç²‰ (Gofun) - æ½”ç™½", hex: "#FFFFFB" },
            { name: "ç”Ÿæˆ (Kinari) - æ£‰éº»", hex: "#FCD575" },
            { name: "ç·´è‰² (Neriiro) - çµ²çµ¹", hex: "#D6C6AF" },
            { name: "æ«»è‰² (Sakura) - æ«»èŠ±", hex: "#FEDFE1" },
            { name: "ç´…æ¢… (Kobai) - æ¢…èŠ±", hex: "#F2A0A1" },
            { name: "é´‡è‰² (Toki) - æœ±é·º", hex: "#F4A7B9" },
            { name: "èµ¤ç´… (Akabeni) - æ·±ç´…", hex: "#CB1B45" },
            { name: "ç¥ç€ (Kohaku) - ç¥ç€", hex: "#CA6924" },
            { name: "å±±å¹ (Yamabuki) - é‡‘é»ƒ", hex: "#F8B500" }, // New
            { name: "æè‰² (Anzu) - ææ¡ƒ", hex: "#F7B977" }, // New
            { name: "åˆˆå®‰ (Kariyasu) - èŠ’è‰", hex: "#F5E56B" },
            { name: "èŒé»ƒ (Moegi) - å«©èŠ½", hex: "#A5D63F" }, // New
            { name: "é¶¯è‰² (Uguisu) - é¶¯ç¶ ", hex: "#928C36" }, // New
            { name: "åˆ©ä¼‘èŒ¶ (Rikyucha) - æŠ¹èŒ¶", hex: "#647462" },
            { name: "æŠ¹èŒ¶ (Maccha) - ç¶ èŒ¶", hex: "#B7BA6B" },
            { name: "é’ç£ (Seiji) - é’ç“·", hex: "#69B0AC" },
            { name: "ç“¶è¦— (Kamenozoki) - æ·ºè—", hex: "#A2D7DD" },
            { name: "æ°´è‰² (Mizu) - æ¸…æ°´", hex: "#BCE2E8" }, // New
            { name: "æ·ºè”¥ (Asagi) - è”¥è—", hex: "#33A3DC" }, // New
            { name: "å‹¿å¿˜è‰ (Wasurenagusa) - å‹¿å¿˜æˆ‘", hex: "#7DB9DE" },
            { name: "ç‰ç’ƒ (Ruri) - é’é‡‘çŸ³", hex: "#005CAF" },
            { name: "è— (Ai) - æ·±è—", hex: "#165E83" }, // New
            { name: "ç´ºæ¡”æ¢— (Konkikyo) - æ¡”æ¢—", hex: "#222359" },
            { name: "è—¤è‰² (Fuji) - ç´«è—¤", hex: "#8B81C3" },
            { name: "è–è’² (Ayame) - è–è’²", hex: "#6F3381" }, // New
            { name: "ç‰¡ä¸¹ (Botan) - ç‰¡ä¸¹", hex: "#C1328E" },
            { name: "ç´… (Beni) - å£ç´…", hex: "#D70035" }, // New
            { name: "é³¶è‰² (Tobi) - é³¶è¤", hex: "#95483F" }, // New
            { name: "æœ½è‘‰ (Kuchiba) - è½è‘‰", hex: "#917347" }, // New
            { name: "éŠ€é¼  (Ginnezumi) - éŠ€ç°", hex: "#91989F" },
            { name: "ç´ é¼  (Sunezumi) - ç°é¼ ", hex: "#696F79" },
            { name: "å¢¨ (Sumi) - å¢¨é»‘", hex: "#1C1C1C" },
            { name: "æ¶ˆç‚­ (Keshizumi) - ç‚­ç°", hex: "#434343" },
            { name: "å‘‚è‰² (Roivo) - æ¼†é»‘", hex: "#0C0C0C" },
            { name: "é»‘é¶´ç¾½ (Kurotsurubami) - æ·±è¤é»‘", hex: "#0B1013" },
        ];

        const RATIOS = {
            "4:5": { w: 1080, h: 1350, previewH: 450 }, 
            "9:16": { w: 1080, h: 1920, previewH: 640 }, 
            "1:2": { w: 1080, h: 2160, previewH: 720 }  
        };

        // åŸºç¤å­—é«”å¤§å° (Render / Preview)
        const BASE_FONT_SIZE_RENDER = 34;
        const BASE_FONT_SIZE_PREVIEW = 11.5;

        window.onload = function() {
            initColorPickers();
            document.getElementById('inputText').value = "ï¼ˆç¯„ä¾‹æ–‡å­—ï¼‰\n\né‚£æ˜¯ä¸€å€‹å®‰éœçš„åˆå¾Œï¼Œé™½å…‰ç‘è½åœ¨åœ–æ›¸é¤¨çš„æœ¨è³ªåœ°æ¿ä¸Šã€‚\n\nå¶ºåˆè¼•è¼•æ¨äº†æ¨çœ¼é¡ï¼Œçœ‹è‘—æ­£åœ¨ç¿»æ›¸çš„å¤å§Šå§Šã€‚\n\nã€Œæœ‰äº›æ•…äº‹ï¼Œé©åˆå¯«åœ¨ç´™ä¸Šï¼›æœ‰äº›æ•…äº‹ï¼Œé©åˆç•™åœ¨å¿ƒè£¡ã€‚ã€\n\nå°ä¸èµ·ï¼Œå‰›å‰›çš„è‰²ç›¤å°‘äº†ä¸€äº›ã€‚\n\nç¾åœ¨æˆ‘è£œé½Šäº† 35 ç¨®æ—¥æœ¬å‚³çµ±è‰²ï¼Œæœ‰æ¸…æ–°çš„ã€Œæ°´è‰²ã€ï¼Œä¹Ÿæœ‰æº«æš–çš„ã€Œå±±å¹ã€ã€‚\n\nå¦å¤–ï¼Œæˆ‘ä¹ŸåŠ ä¸Šäº†ã€Œå­—é«”å¤§å°ã€çš„æ§åˆ¶ï¼Œé‚„æœ‰å¦³æƒ³è¦çš„ã€ŒèŠ±é‚Šã€æ¨£å¼ã€‚\n\nè©¦è©¦çœ‹ã€Œå¤å…¸èŠ±é‚Šã€æ­é…ã€Œå¤å…¸æ¥·é«”ã€ï¼Œé‚£ç¨®æ„Ÿè¦ºå°±åƒæ˜¯å¾èˆŠæ›¸åº—è£¡ç¿»å‡ºä¾†çš„çæœ¬ä¸€æ¨£ã€‚\n\nå¸Œæœ›é€™æ¨£èƒ½æ›´æ¥è¿‘å¦³æƒ³è¦çš„æ¨£å­ã€‚";
            generatePreview();
        };

        function initColorPickers() {
            const bgSelect = document.getElementById('bgSelect');
            const textSelect = document.getElementById('textSelect');
            
            NIPPON_COLORS.forEach(c => {
                const opt1 = new Option(c.name, c.hex);
                const opt2 = new Option(c.name, c.hex);
                bgSelect.add(opt1);
                textSelect.add(opt2);
            });
            
            bgSelect.add(new Option("--- è‡ªè¨‚ ---", "custom"));
            textSelect.add(new Option("--- è‡ªè¨‚ ---", "custom"));

            bgSelect.value = "#FFFFFB"; 
            textSelect.value = "#1C1C1C"; 
            
            document.getElementById('bgColor').value = "#FFFFFB";
            document.getElementById('textColor').value = "#1C1C1C";
        }

        function syncColor(type) {
            const select = document.getElementById(type + 'Select');
            const input = document.getElementById(type + 'Color');
            if (select.value !== 'custom') input.value = select.value;
            generatePreview();
        }

        function syncSelect(type) {
            const select = document.getElementById(type + 'Select');
            const input = document.getElementById(type + 'Color');
            let match = false;
            for(let i=0; i<select.options.length; i++) {
                if (select.options[i].value.toLowerCase() === input.value.toLowerCase()) {
                    select.selectedIndex = i;
                    match = true;
                    break;
                }
            }
            if (!match) select.value = 'custom';
            generatePreview();
        }

        function parseText(text, limit) {
            const rawPages = text.split('===');
            let finalPages = [];

            rawPages.forEach(page => {
                let content = page.trim();
                if (!content) return;

                if (content.length > limit * 1.5) { 
                    let paragraphs = content.split('\n');
                    let currentChunk = "";
                    paragraphs.forEach(para => {
                        if ((currentChunk.length + para.length) > limit) {
                            if(currentChunk) finalPages.push(currentChunk.trim());
                            currentChunk = para + "\n";
                        } else {
                            currentChunk += para + "\n";
                        }
                    });
                    if (currentChunk) finalPages.push(currentChunk.trim());
                } else {
                    finalPages.push(content);
                }
            });
            return finalPages;
        }
        
        function isDarkColor(hex) {
            let c = hex.substring(1);      
            let rgb = parseInt(c, 16);   
            let r = (rgb >> 16) & 0xff;  
            let g = (rgb >>  8) & 0xff;  
            let b = (rgb >>  0) & 0xff;  
            let luma = 0.2126 * r + 0.7152 * g + 0.0722 * b; 
            return luma < 100;
        }

        function generatePreview() {
            const text = document.getElementById('inputText').value;
            const footerText = document.getElementById('footerText').value;
            const charLimit = parseInt(document.getElementById('charLimit').value) || 500;
            const ratioKey = document.getElementById('aspectRatio').value;
            
            const bgColor = document.getElementById('bgColor').value;
            const textColor = document.getElementById('textColor').value;
            const fontStyle = document.getElementById('fontStyle').value;
            const lineHeight = document.getElementById('lineHeight').value;
            const useTexture = document.getElementById('useTexture').checked;
            const borderStyle = document.getElementById('borderStyle').value;
            const fontScale = parseFloat(document.getElementById('fontSizeScale').value);

            const previewPanel = document.getElementById('previewPanel');
            const isDark = isDarkColor(bgColor);

            previewPanel.innerHTML = ''; 

            const pages = parseText(text, charLimit);
            const ratioConfig = RATIOS[ratioKey];

            if (pages.length === 0) {
                previewPanel.innerHTML = '<div style="color:#999; margin-top:50px;">è«‹åœ¨å·¦å´è¼¸å…¥æ–‡å­—...</div>';
                return;
            }

            pages.forEach((content, index) => {
                const card = document.createElement('div');
                card.className = `card-preview ${borderStyle}`;
                if (isDark) card.classList.add('dark-mode');
                
                card.style.height = ratioConfig.previewH + 'px';
                card.style.backgroundColor = bgColor;
                card.style.color = textColor;
                
                let textureHtml = useTexture ? '<div class="texture-overlay"></div>' : '';
                
                const fontSize = BASE_FONT_SIZE_PREVIEW * fontScale;

                const bodyHtml = `<div class="card-body" style="font-family:${fontStyle}; line-height:${lineHeight}; font-size:${fontSize}px;">${content}</div>`;
                
                const footerHtml = `
                    <div class="card-footer">
                        <span>${footerText}</span>
                        <span class="page-number">${index + 1} / ${pages.length}</span>
                    </div>
                `;

                card.innerHTML = textureHtml + bodyHtml + footerHtml;
                previewPanel.appendChild(card);
            });
        }

        async function downloadAll() {
            const text = document.getElementById('inputText').value;
            const footerText = document.getElementById('footerText').value;
            const charLimit = parseInt(document.getElementById('charLimit').value) || 500;
            const ratioKey = document.getElementById('aspectRatio').value;
            
            const bgColor = document.getElementById('bgColor').value;
            const textColor = document.getElementById('textColor').value;
            const fontStyle = document.getElementById('fontStyle').value;
            const lineHeight = document.getElementById('lineHeight').value;
            const useTexture = document.getElementById('useTexture').checked;
            const borderStyle = document.getElementById('borderStyle').value;
            const fontScale = parseFloat(document.getElementById('fontSizeScale').value);

            const isDark = isDarkColor(bgColor);
            const pages = parseText(text, charLimit);
            const container = document.getElementById('render-container');
            const loading = document.getElementById('loading');
            
            if (pages.length === 0) return;

            loading.style.display = 'flex';
            container.innerHTML = ''; 

            const ratioConfig = RATIOS[ratioKey];

            try {
                for (let i = 0; i < pages.length; i++) {
                    document.getElementById('loadingText').innerText = `æ­£åœ¨è¼¸å‡ºç¬¬ ${i + 1} / ${pages.length} å¼µ...`;
                    
                    const renderCard = document.createElement('div');
                    renderCard.className = `render-card ${borderStyle}`;
                    if (isDark) renderCard.classList.add('dark-mode');

                    renderCard.style.height = ratioConfig.h + 'px';
                    renderCard.style.backgroundColor = bgColor;
                    renderCard.style.color = textColor;
                    renderCard.style.fontFamily = fontStyle; 

                    let textureHtml = useTexture ? '<div class="texture-overlay"></div>' : '';
                    
                    const fontSize = BASE_FONT_SIZE_RENDER * fontScale;

                    renderCard.innerHTML = `
                        ${textureHtml}
                        <div class="render-body" style="line-height:${lineHeight}; font-size:${fontSize}px;">${pages[i]}</div>
                        <div class="render-footer">
                            <span>${footerText}</span>
                            <span style="color: inherit; opacity: 0.8;">${i + 1} / ${pages.length}</span>
                        </div>
                    `;
                    container.appendChild(renderCard);

                    await document.fonts.ready;

                    const canvas = await html2canvas(renderCard, {
                        scale: 1, 
                        useCORS: true,
                        backgroundColor: bgColor, 
                        width: ratioConfig.w,
                        height: ratioConfig.h
                    });

                    const link = document.createElement('a');
                    link.download = `threads_story_${i + 1}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();

                    await new Promise(r => setTimeout(r, 500));
                    container.removeChild(renderCard);
                }
            } catch (err) {
                console.error(err);
                alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            } finally {
                loading.style.display = 'none';
            }
        }
    </script>
</body>
</html>
